extends layout

block content
    script(type="application/lua").
        print("hello bot!")
    script.
        var bet_total_stats = {
            id: "bet_total_stats",
            view: "property",
            height: 200,
            //width: 0,
            elements: [
                {label: "TOTAL STATS", type: "label"},
                {label: "BALANCE", id: "bet_total_stats_balance", value:"0", type: "text"},
                {label: "WIN", type: "text", id: "bet_total_stats_win", value:"0"},
                {label: "LOSS", type: "text", id: "bet_total_stats_loss", value:"0"},
                {label: "BET", type: "text", id: "bet_total_stats_bet", value:"0"},
                {label: "PROFIT", type: "text", id: "bet_total_stats_profit", value:"0"},
                {label: "WAGERED", type: "text", id: "bet_total_stats_wagered", value:"0"},
            ]
        };


            var bet_current_stats = {
                id: "bet_current_stats",
                view: "property",
                height: 200,
                //width: 0,
                elements: [
                    {label: "CURRENT STATS", type: "label"},
                    {label: "BALANCE", type: "text", id: "bet_current_stats_balance", value:"0"},
                    {label: "WIN", type: "text", id: "bet_current_stats_win", value:"0"},
                    {label: "LOSS", type: "text", id: "bet_current_stats_loss", value:"0"},
                    {label: "BET", type: "text", id: "bet_current_stats_bet", value:"0"},
                    {label: "PROFIT", type: "text", id: "bet_current_stats_profit", value:"0"},
                    {label: "WAGERED", type: "text", id: "bet_current_stats_wagered", value:"0"},
                ]
            };

            var bet_currency_selection = {
                id: "bet_currency_selection",
                options: [
                    {id:1,value:"BTC"},
                    {id:2,value:"Doge"},
                    {id:3,value:"LTC"},
                    {id:4,value:"ETH"}
                ],
                view: "richselect",
                left: 70,
                top: 70,
                width: 400,
                value: 1,
                label: "CURRENCY",
                labelWidth: 100,
                placeholder: "BTC",
                name: "currency"
            };

            var reset_session_button = {
                id: "reset_session_button",
                view: "button",
                label: "RESET SESSION",
            // height: 0,
                width: 400
            };

            var switch_site_button = {
                id: "switch_site_button",
                view: "button",
                type: "danger",
                label: "LOGOUT/SWITCH SITE",
                width: 400
            };

            var bet_chart = {
                id: "bet_chart",
                view: "chart",
                height: 0,
                width: 0,
                type: "spline",
                value: "#yValue#",
                cellWidth: 10,
                dynamic: true,
                label: function (obj) {
                    return parseInt(obj.yValue, 10);
                },
                item: {
                    borderColor: "#1293f8",
                    color: "#ffffff"
                },
                line: {
                    color: "#1293f8",
                    width: 3
                },
                xAxis: {
                    template: "#xValue#"
                },
                yAxis: {},
                series: [
                    {
                        value: "#yValue#",
                        item: {
                            borderColor: "#1293f8",
                            color: "#ffffff"
                        },
                        line: {
                            color: "#1293f8",
                            width: 2
                        },
                        tooltip: {
                            template: "#yValue#"
                        }
                    }
                ]
            };

            var bet_datatable = {
                id: "bet_datatable",
                view: "datatable",
                columns: [
                    {id: "bet_datatable_id", header: "ID", fillspace:true},
                    {id: "bet_datatable_bet_chance", header: "GAME", fillspace:true},
                    {id: "bet_datatable_actual_chance", header: "ROLL", fillspace:true},
                    {id: "bet_datatable_amount", header: "AMOUNT", fillspace:true},
                    {id: "bet_datatable_payout", header: "PAYOUT", fillspace:true},
                    {id: "bet_datatable_profit", header: "PROFIT", fillspace:true}
                ]
            };

            var bet_config_tabview = {
                id: "bet_config_tabview",
                view: "tabview",
                minHeight: 500,
                width: 400,
                cells: [
                    {
                        header: "MANUAL",
                        body: {
                            id: "manual_bet_form",
                            view: "form",
                            minHeight: 500,
                            width: 0,
                            elements: [
                                //- {
                                //-     id: "manual_bet_seed_info", 
                                //-     view: "text", 
                                //-     value: "",
                                //-     label: "SEED"
                                //- },
                                //- {
                                //-     id: "manual_bet_reset_seed_button",
                                //-     view: "button",
                                //-     type: "danger",
                                //-     label: "RESET SEED",
                                //- },
                                {
                                    id: "manual_bet_amount",
                                    view: "text",
                                    label: "BET AMOUNT",
                                    value: "0.00000001",
                                    labelWidth: 200,
                                    name: "manual_bet_amount"
                                },
                                {
                                    cols: [
                                        {
                                            id: "manual_bet_amount_min_button",
                                            view: "button",
                                            label: "MIN",
                                        },
                                        {
                                            id: "manual_bet_amount_max_button",
                                            view: "button",
                                            label: "MAX",
                                        },
                                        {
                                            id: "manual_bet_amount_half_button",
                                            view: "button",
                                            label: "1/2",
                                        },
                                        {
                                            id: "manual_bet_amount_double_button",
                                            view: "button",
                                            label: "2x",
                                        },
                                    ]
                                },
                                {
                                    id: "manual_bet_chance",
                                    view: "text",
                                    label: "BET CHANCE",
                                    value: "49.50",
                                    labelWidth: 200,
                                    name: "manual_bet_chance"
                                },
                                {
                                    id: "manual_bet_low_button",
                                    view: "button",
                                    type: "form",
                                    label: "BET LOW",
                                },
                                {
                                    id: "manual_bet_high_button",
                                    view: "button",
                                    type: "form",
                                    label: "BET HIGH",
                                }
                            ]
                        }
                    },
                    {
                        header: "AUTO",
                        body: {
                            rows: [
                            {
                            id: "auto_bet_form",
                            view: "form",
                            height: 0,
                            width: 0,
                            scroll:true,
                            elements: [
                                {
                                    id: "auto_bet_number_of_bets",
                                    view: "text",
                                    label: "NUM OF BETS(0:UNLIMITED)",
                                    labelWidth: 250,
                                    value: "0"
                                },
                                {
                                    id: "auto_bet_start_low_high",
                                    view: "richselect",
                                    label: "START(LOW/HIGH)",
                                    labelWidth: 250,
                                    value: "LOW",
                                    options: ["LOW", "HIGH"]
                                },
                                {
                                    id: "auto_bet_base_amount",
                                    view: "text",
                                    label: "BET BASE AMOUNT",
                                    value: "0.00000001",
                                    labelWidth: 248,
                                    name: "auto_bet_base_amount"
                                },
                                {
                                    cols:[
                                        {
                                            id: "auto_bet_amount_radio_on_loss",
                                            label: "ON LOSS",
                                            view: "radio",
                                            value: "RESET TO BASE AMOUNT",
                                            options: [
                                                {value: "RESET TO BASE AMOUNT"}, 
                                                {value: "MULTIPLIER", newline:true}
                                            ]
                                        },
                                        {
                                            rows:[
                                                {view: "label"},
                                                {
                                                    id: "auto_bet_amount_radio_on_loss_multiplier",
                                                    view: "text",
                                                    width: 60,
                                                    value: "2"
                                                }

                                            ]
                                        }
                                    ]

                                },
                                {
                                    cols:[
                                        {
                                            id: "auto_bet_amount_radio_on_win",
                                            label: "ON WIN",
                                            view: "radio",
                                            value: "RESET TO BASE AMOUNT",
                                            options: [
                                                {value:"RESET TO BASE AMOUNT"}, 
                                                {value:"MULTIPLIER", newline:true}
                                            ]
                                        },
                                        {
                                            rows: [
                                                {view: "label"},
                                                {
                                                    id: "auto_bet_amount_radio_on_win_multiplier",
                                                    view: "text",
                                                    width: 60,
                                                    value: "2"
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    id: "auto_bet_base_chance",
                                    view: "text",
                                    label: "BET BASE CHANCE",
                                    value: "49.50",
                                    labelWidth: 248,
                                    name: "auto_bet_base_chance"
                                },
                                {
                                    cols:[
                                        {
                                            id: "auto_bet_stop_on_roll",
                                            label: "STOP ON ROLL",
                                            view: "label",
                                            labelWidth: 150,
                                            name: "auto_bet_stop_on_roll"
                                        },
                                        {
                                            id: "auto_bet_roll_min",
                                            label: "MIN",
                                            view: "text",
                                            labelWidth: 40,
                                            width: 100,
                                            value: "0.00",
                                            name: "auto_bet_roll_min"
                                        },
                                        {
                                            id: "auto_bet_roll_max",
                                            label: " -- MAX",
                                            view: "text",
                                            labelWidth: 60,
                                            width: 120,
                                            value: "0.00",
                                            name: "auto_bet_roll_max"
                                        }
                                    ]
                                },
                                {
                                    id: "auto_bet_stop_on_profit",
                                    view: "text",
                                    label: "STOP ON PROFIT(0:NON-STOP)",
                                    labelWidth: 248,
                                    value: "0.00000000",
                                    name: "auto_bet_stop_on_profit"
                                },
                                {
                                    id: "auto_bet_stop_on_win",
                                    view: "text",
                                    label: "STOP ON WIN(0:NON-STOP)",
                                    labelWidth: 248,
                                    value: "0",
                                    name: "auto_bet_stop_on_win"
                                },
                                {
                                    id: "auto_bet_stop_on_loss",
                                    view: "text",
                                    label: "STOP ON LOSS(0:NON-STOP)",
                                    labelWidth: 248,
                                    value: "0",
                                    name: "auto_bet_stop_on_loss"
                                },
                            ]
                        },
                        {
                            id: "auto_bet_form_start_stop_buttons",
                            view: "form",
                            height: 0,
                            width: 0,
                            elements: [
                                {
                                    id: "auto_bet_start_stop_button",
                                    view: "button",
                                    type: "form",
                                    label: "START",
                                    value: "START"
                                },
                                {
                                    id: "auto_bet_stop_on_next_win_button",
                                    view: "button",
                                    type: "form",
                                    label: "STOP ON NEXT WIN"
                                },
                                {
                                    id: "auto_bet_stop_on_next_loss_button",
                                    view: "button",
                                    type: "form",
                                    label: "STOP ON NEXT LOSS"
                                },
                            ]}
                        ]} 
                    },
                    {
                        header: "SCRIPT",
                        body: {
                            id: "script_bet_form",
                            view: "form",
                            height: 0,
                            width: 0,
                            elements: [
                                {
                                    id: "script_bet_coding_board",
                                    view: "textarea",
                                    minHeight: 300
                                },
                                {
                                    id: "script_bet_start_stop_button",
                                    view: "button",
                                    type: "form",
                                    label: "START",
                                    value: "START"
                                },
                                {
                                    id: "script_bet_stop_on_next_win_button",
                                    view: "button",
                                    type: "form",
                                    label: "STOP ON NEXT WIN"
                                },
                                {
                                    id: "script_bet_stop_on_next_loss_button",
                                    view: "button",
                                    type: "form",
                                    label: "STOP ON NEXT LOSS"
                                },

                            ]
                        }
                    }
                ]
            };

            var resizer = {view:"resizer"};

            webix.ui({
                id: "bet_layout",
                rows: [
                    {
                        cols: [
                            bet_total_stats,
                            resizer,
                            bet_current_stats,
                            resizer,
                            {
                                rows: [
                                    bet_currency_selection, 
                                    reset_session_button,
                                    switch_site_button
                                ]
                            }
                        ]
                    },
                    {view: "resizer"},
                    {
                        cols: [
                            {rows: [bet_chart, {view: "resizer"}, bet_datatable]},
                            resizer,
                            bet_config_tabview
                        ]
                    },
                ]
            });
            webix.extend($$("bet_chart"), webix.ProgressBar);
            let isLoop = false;
            let stopOnWin = false;
            let stopOnLoss = false;
            $$("script_bet_start_stop_button").attachEvent("onItemClick", function(){
                let status = $$("script_bet_start_stop_button").getValue();
                if(status == 'STOP') {
                    isLoop = false;
                    $$("script_bet_start_stop_button").setValue('START');
                } else {
                    let currencyValue = $$("bet_currency_selection").getValue() -1;
                    fengari.load('bethigh= false')();
                    initScriptBalance(currencyValue, function(){
                        let code = $$("script_bet_coding_board").getValue();
                        try {
                            code = code.replace(/!=/g,"~=");
                            code = code.replace(/!/g,"not ");
                            code = code.replace(/base/g,'basebet');
                            code = code.replace(/basebetbet/g,'basebet');
                            code = code.replace(/([a-zA-Z]*[0-9]*\s*)\+\=(\s*[a-zA-Z]*[0-9]*)/g, '$1=$1+$2 ');
                            code = code.replace(/([a-zA-Z]*[0-9]*\s*)\-\=(\s*[a-zA-Z]*[0-9]*)/g, '$1=$1-$2 ');
                            code = code.replace(/([a-zA-Z]*[0-9]*\s*)\*\=(\s*[a-zA-Z]*[0-9]*)/g, '$1=$1*$2 ');
                            code = code.replace(/([a-zA-Z]*[0-9]*\s*)\/\=(\s*[a-zA-Z]*[0-9]*)/g, '$1=$1/$2 ');
                            fengari.load(code)();
                        } catch(err){
                            webix.message({type: 'error', text: "load error:"+err.message});
                            return false;
                        }
                        isLoop = true;
                        $$("script_bet_start_stop_button").setValue('STOP');
                        scriptBet(true);
                    });
                }
            });
            $$("auto_bet_start_stop_button").attachEvent("onItemClick", function(){
                let status = $$("auto_bet_start_stop_button").getValue();
                if(status == 'STOP') {
                    isLoop = false;
                    $$("auto_bet_start_stop_button").setValue('START');
                } else {
                    $$("auto_bet_start_stop_button").setValue('STOP');
                    autoBet();
                    isLoop = true;
                    stopOnWin = false;
                    stopOnLoss = false;
                }
            });
            $$("manual_bet_amount_min_button").attachEvent("onItemClick", function(){
                $$("manual_bet_amount").setValue("0.00000001");
            });
            $$("manual_bet_amount_max_button").attachEvent("onItemClick", function(){
                getInfo(function(userinfo){
                    let balance = getBalance(userinfo);
                    $$("manual_bet_amount").setValue(balance);
                });
            });
            $$("manual_bet_amount_half_button").attachEvent("onItemClick", function(){
                let betAmount = $$("manual_bet_amount").getValue()/2;
                $$("manual_bet_amount").setValue(Math.max(0.00000001, betAmount).toFixed(8));
            });
            $$("manual_bet_amount_double_button").attachEvent("onItemClick", function(){
                getInfo(function(userinfo){
                    let balance = getBalance(userinfo);
                    let currencyValue = $$("bet_currency_selection").getValue() -1;
                    let betAmount = $$("manual_bet_amount").getValue()*2;
                    $$("manual_bet_amount").setValue(Math.min(balance, betAmount).toFixed(8));
                });
            });
            $$("auto_bet_stop_on_next_win_button").attachEvent("onItemClick", function(){
                stopOnWin = true;
            });
            $$("auto_bet_stop_on_next_loss_button").attachEvent("onItemClick", function(){
                stopOnLoss = true;
            });
            $$("script_bet_stop_on_next_win_button").attachEvent("onItemClick", function(){
                stopOnWin = true;
            });
            $$("script_bet_stop_on_next_loss_button").attachEvent("onItemClick", function(){
                stopOnLoss = true;
            });
            $$("switch_site_button").attachEvent("onItemClick", function(id, e){
                let box = webix.confirm({
                    title:"CONFIRMATION",
                    ok:"Yes",
                    cancel:"No",
                    text:"Logout/Switch Site will reset current session. Sure?",
                    callback:function(result){
                        if(result) {
                            let domain = document.domain;
                            console.log(domain);
                            window.location.href = '../login';
                        }
                    }
                });
            });
            $$("manual_bet_low_button").attachEvent("onItemClick", function(){
                var currency = $$("bet_currency_selection").getText().toLowerCase();
                var payIn = $$("manual_bet_amount").getValue();
                var chance = $$("manual_bet_chance").getValue();
                bet(currency, 0, parseInt(payIn*100000000), chance);
            });
            $$("manual_bet_high_button").attachEvent("onItemClick", function(){
                var currency = $$("bet_currency_selection").getText().toLowerCase();
                var payIn = $$("manual_bet_amount").getValue();
                var chance = $$("manual_bet_chance").getValue();
                bet(currency, 1, parseInt(payIn*100000000), chance);
            });
            $$("bet_currency_selection").attachEvent("onChange", function(newId, oldId){
                refresh(newId);
            });
            $$("reset_session_button").attachEvent("onItemClick", function(){
                webix.confirm({
                    title:"CONFIRMATION",
                    ok:"Yes",
                    cancel:"No",
                    text:"Reset current session. Sure?",
                    callback:function(result){
                        if(result){
                            let currencyValue = $$("bet_currency_selection").getValue();
                            refresh(currencyValue);
                        }
                    }
                });
            });
            webix.ready(function(){
                init();
                refresh(1);
            });
            function autoBet(iswin, previousbet){
                let nums =  $$("auto_bet_number_of_bets").getValue();
                let currency = $$("bet_currency_selection").getText().toLowerCase();
                let base = $$("auto_bet_base_amount").getValue();
                let chance = $$("auto_bet_base_chance").getValue();
                let lowHigh = $$("auto_bet_start_low_high").getValue() == 'LOW' ?0:1;
                let autoLossRadio = $$("auto_bet_amount_radio_on_loss").getValue();
                let autoWinRadio = $$("auto_bet_amount_radio_on_win").getValue();
                if(iswin == true && autoWinRadio == 'MULTIPLIER'){
                    let multiWin = $$("auto_bet_amount_radio_on_win_multiplier").getValue();
                    base = previousbet * multiWin;
                    console.log('win'+multiWin);
                } else if(iswin == false && autoLossRadio == 'MULTIPLIER') {
                    let multiLoss = $$("auto_bet_amount_radio_on_loss_multiplier").getValue();
                    base = previousbet * multiLoss;
                    console.log('loss'+multiLoss);
                }
                console.log(lowHigh,base,nums,currency,chance);
                bet(currency, lowHigh, Math.round(parseFloat(base*100000000)), chance);
            }
            function scriptBet(init){
                try{
                    let nextbet = fengari.load('return nextbet')();
                    let previousbet = fengari.load('return previousbet')();
                    let chance = fengari.load('return chance')();
                    let currency = $$("bet_currency_selection").getText().toLowerCase();
                    let lowHigh = fengari.load('return bethigh')() == false ?0:1;
                    if(init){
                        fengari.load('nextbet=basebet')();
                        nextbet = fengari.load('return basebet')();
                        fengari.load('previousbet=basebet\ncurrentprofit=0\ncurrentstreak=0\nwins=0\nlosses=0\nbets=0\nisloop=true\nprofit=0\n')();
                        fengari.load('function stop()\nisloop = false \n print(isloop)\nend')();
                    } else {
                        fengari.load('dobet()')();
                        nextbet = fengari.load('return nextbet')();
                        chance = fengari.load('return chance')();
                        lowHigh = fengari.load('return bethigh')() == false ?0:1;
                    }
                    fengari.load('previousbet=nextbet')();
                    fengari.load('print("script",basebet,nextbet,previousbet,chance,win,currentprofit,currentstreak,wins,losses,bets,bethigh,isloop,profit)')();
                    betScript(currency, lowHigh, Math.round(parseFloat(nextbet*100000000)), chance);
                }catch(err){
                    console.log(err)
                    $$("script_bet_start_stop_button").setValue('START');
                    webix.message({type: 'error', text:"script error:"+ err});
                }
            }
            function action(c,h,p,ch,cv,cb){
                webix.ajax().post('bet', { Currency:c, PayIn:p, High:h, Chance:ch, CurrencyValue: cv }).then(function (result) {
                    let ret = result.json();
                    cb(ret);
                }).fail(function (xhr) {
                    var response = JSON.parse(xhr.response);
                    $$("auto_bet_start_stop_button").setValue('START');
                    webix.message({type: 'error', text: response.error.message});
                });
            }
            
            function bet(c,h,p,ch) {
                console.log('aaaaa',c,h,p,ch);
                if(!checkParams(p,ch)) {
                    $$("auto_bet_start_stop_button").setValue('START');
                    webix.message({type: 'error', text: 'Please enter the correct parameters'});
                    return false;
                }
                let iswin = false;
                $$("bet_chart").showProgress({
                    type:"icon",
                    delay:3000
                });
                let currencyValue = $$("bet_currency_selection").getValue() -1;
                action(c,h,p,ch,currencyValue,function(ret) {
                    console.log(ret);
                    try{
                    if(isError(ret)) {
                            iswin = getWinStatus(ret);
                            setChart(ret, count, currencyValue);
                            setDatatable(ret, iswin);
                            setStats(ret.info, currencyValue);
                            count++
                    } else {
                        isLoop = outError(ret);
                    }
                    $$("bet_chart").hideProgress();
                    console.log(isLoop, stopOnWin, stopOnLoss, iswin);
                    if (stopOnWin == true && iswin) {
                        console.log("stop on win");
                        isLoop = false;
                    }
                    if (stopOnLoss == true && !iswin) {
                        console.log("stop on loss");
                        isLoop = false;
                    }
                    if (isLoop) {
                        let currentRoll = getCurrentRoll(ret);
                        let rollMin = $$("auto_bet_roll_min").getValue();
                        let rollMax = $$("auto_bet_roll_max").getValue();
                        if(currentRoll <= rollMax && currentRoll >= rollMin){
                            console.log("currentRoll stop");
                            isLoop = false;
                        }
                        let actProfit = getActProfit(ret.info, currencyValue);
                        let stopProfit = $$("auto_bet_stop_on_profit").getValue()*100000000;
                        if(stopProfit != 0) {
                            if(actProfit>=stopProfit && stopProfit>0){
                                    isLoop = false;
                            }
                            console.log(actProfit,stopProfit);
                            if(actProfit<=stopProfit && stopProfit<0){
                                console.log("act profit stop");
                                    isLoop = false;
                            }
                        }
                        let nums =  $$("auto_bet_number_of_bets").getValue();
                        if(nums>0){
                            $$("auto_bet_number_of_bets").setValue(nums-1);
                            if(nums == 1) {
                                isLoop = false;
                            }
                        }
                        let lossNums =  $$("auto_bet_stop_on_loss").getValue();
                        if(lossNums>0 && !iswin){
                            $$("auto_bet_stop_on_loss").setValue(lossNums-1);
                            if(lossNums == 1) {
                                isLoop = false;
                            }
                        }
                        let winNums =  $$("auto_bet_stop_on_win").getValue();
                        if(winNums>0 && iswin){
                            $$("auto_bet_stop_on_win").setValue(winNums-1);
                            if(winNums == 1) {
                                isLoop = false;
                            }
                        }
                        if(isLoop){
                            autoBet(iswin,(p/100000000).toFixed(8));
                        } else {
                            $$("auto_bet_start_stop_button").setValue('START');
                        }
                    } else {
                        $$("auto_bet_start_stop_button").setValue('START');
                    }
                    } catch(err){
                        $$("auto_bet_start_stop_button").setValue('START');
                        webix.message({type: 'error', text: err.message});
                    }
                });
            }
            let count = 1;
            function betScript(c,h,p,ch) {
                if(!checkParams(p,ch)) {
                    $$("script_bet_start_stop_button").setValue('START');
                    webix.message({type: 'error', text: 'Please enter the correct parameters'});
                    return false;
                }
                let iswin = false;
                if(isLoop){
                    isLoop = fengari.load('return isloop')();
                    if(!isLoop){
                        $$("script_bet_start_stop_button").setValue('START');
                        return false;
                    }
                }
                $$("bet_chart").showProgress({
                    type:"icon",
                    delay:3000
                });
                let currencyValue = $$("bet_currency_selection").getValue() -1;
                action(c,h,p,ch,currencyValue,function(ret) {
                    if(isError(ret)) {
                        try {
                            iswin = getWinStatus(ret);
                            setBetToLua(ret, currencyValue);
                            setChart(ret, count, currencyValue);
                            setDatatable(ret, iswin);
                            setStats(ret.info, currencyValue);
                        } catch(err){
                            webix.message({type: 'error', text: err.message});
                        }
                        count++;
                    } else {
                        isLoop = outError(ret);
                    }
                    $$("bet_chart").hideProgress();
                    console.log(isLoop, stopOnWin, stopOnLoss, iswin);
                    if (stopOnWin == true && iswin) {
                        console.log("stop on win");
                        isLoop = false;
                    }
                    if (stopOnLoss == true && !iswin) {
                        console.log("stop on loss");
                        isLoop = false;
                    }
                    if (isLoop) {
                        scriptBet(false);
                    } else {
                        $$("script_bet_start_stop_button").setValue('START');
                    }
                });
            }
            function clearSession(){
                $$('bet_datatable').clearAll();
                $$("bet_chart").clearAll();
                stopOnWin = false;
                stopOnLoss = false;
            }
            function refresh(newId) {
                clear(function(userinfo){
                    setStats(userinfo, newId-1);
                    $$('bet_datatable').clearAll();
                    $$("bet_chart").clearAll();
                    clearSession();
                });
            }
            function clear(cb){
                $$("bet_chart").showProgress({
                    type:"icon",
                    delay:3000
                });
                webix.ajax().get('clear?currency='+$$("bet_currency_selection").getText().toLowerCase()).then(function (result) {
                    let ret = result.json();
                    console.log(ret);
                    $$("bet_chart").hideProgress();
                    cb(ret);
                });
            }
            function getInfo(cb){
                $$("bet_chart").showProgress({
                    type:"icon",
                    delay:3000
                });
                webix.ajax().get('refresh?currency='+$$("bet_currency_selection").getText().toLowerCase()).then(function (result) {
                    let ret = result.json();
                    $$("bet_chart").hideProgress();
                    cb(ret);
                });
            }
            function setStreak(win){
                if(win){
                    fengari.load('wins=wins+1\nif currentstreak>=0 then \n currentstreak=currentstreak+1\n else \n currentstreak=1\n end')()
                } else {
                    fengari.load('losses=losses+1\nif currentstreak<=0 then \n currentstreak=currentstreak-1\n else \n currentstreak=-1\n end')()
                }
            }
    script(src=site)
